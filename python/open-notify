#!/usr/bin/python
import gui.views
import gui.framework
import data.locations
import data.web
import device.iss_notify
import serial
import random

class OpenNotify:

  def __init__(self):
  
    self.app    = gui.framework.Application()
    self.state  = gui.framework.ApplicationData()
    self.device = device.iss_notify.ISSNotify()
    self.api    = data.web.OpenNotifyAPI()

    location_helper = data.locations.Locations()
    self.state.location = location_helper.locations[0]
    self.state.all_locations = location_helper.locations

    self.view  = gui.views.MainWindow(self, self.state)
    self.loc_view = None
    self.app.main = self.view

    self.app.run()

  def connect(self):
    self.device.connect()
    self.device.get_battery_status()
    
    self.state.device_connected       = self.device.conneced
    self.state.device_battery_message = " - " + self.device.battery_status
    
    self.view.update_view()

  def get_next_pass(self):
    self.state.next_pass = self.api.get_pass(self.state.location)
    
    self.view.update_view()

  def manage_locations(self): 
    popup = gui.views.ManageLocations(self, self.state)
    self.loc_view = popup


  def update_location(self, name):
    for l in self.state.all_locations:
        if name == l.name:
            self.state.location = l
            self.view.update_view()
            if self.loc_view:
                self.loc_view.update_view()


  def update_locations(self, newdata):
    
    print newdata

  #===================================================================

  def read_clock(self):
    self.device.read_time()

  def set_clock(self):
    self.device.set_time()

  def clear_alarm(self):
    self.device.clear_alarm0()
  
  def set_alarm(self):
    self.device.set_alarm()

  def get_ms(self):
    self.device.get_ms()

  def blink(self, color):
    
    c = self.rgb2device(color)
    
    try:
      ser = serial.Serial('/dev/ttyACM0', 9600, timeout=0.1)
      
      print "c" + str(c)
      ser.write("c" + str(c))
      
      print "sent command"
      
      """
      for i in range(10):
        line  = ser.readline()
        if line != "":
          for c in line:
            print ord(c),
          
      """
      ser.close()
    except:
      print "No device"
    #print "recieve"

  def rgb2device(self, color):
    
    r = color[0] / 30
    g = color[1] / 30
    b = color[2] / 30
    
    c = r + (g<<4) + (b<<8)
    
    return c

if __name__ == "__main__":
    run = OpenNotify()
